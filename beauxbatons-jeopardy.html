<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Beauxbatons Challenge - Wizards Jeopardy</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <!-- Magical fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600;700&family=Cardo:wght@400;700&display=swap" rel="stylesheet">

  <style>
    :root {
      /* Beauxbatons palette */
      --bb-soft-blue: #a8d5ff;
      --bb-soft-blue-dark: #74a9e5;
      --bb-deep-blue: #1a3358;
      --bb-cream: #fbf3e2;
      --bb-gold: #facc6b;
      --bb-gold-deep: #b37d16;
      --bb-text-dark: #1f2933;
      --bb-text-soft: #3b4258;
    }

    * {
      box-sizing: border-box;
    }

    /* ✨ Magical night-sky background with subtle twinkle */
    body {
      margin: 0;
      font-family: "Cardo", "Georgia", serif;
      background: radial-gradient(circle at top, #14254b 0%, #050816 55%, #000109 100%);
      color: #f9fafb;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      position: relative;
      overflow-x: hidden;
    }

    body::before {
      content: "";
      position: fixed;
      inset: 0;
      pointer-events: none;
      background:
        radial-gradient(circle at 10% 20%, rgba(255,255,255,0.22) 0, transparent 45%),
        radial-gradient(circle at 80% 8%, rgba(191,219,254,0.27) 0, transparent 50%),
        radial-gradient(circle at 20% 80%, rgba(251,191,36,0.18) 0, transparent 45%);
      opacity: 0.35;
      mix-blend-mode: screen;
      animation: twinkle 10s ease-in-out infinite alternate;
      z-index: 0;
    }

    @keyframes twinkle {
      0%   { opacity: 0.2; }
      50%  { opacity: 0.45; }
      100% { opacity: 0.3; }
    }

    /* ===================== INTRO SCREEN ===================== */

    #intro-screen {
      position: fixed;
      inset: 0;
      z-index: 60;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at top, #1b2a4d 0%, #050816 60%, #000109 100%);
      box-shadow: inset 0 0 80px rgba(0,0,0,0.9);
      transition: opacity 0.8s ease;
    }

    #intro-screen.hide-intro {
      opacity: 0;
      pointer-events: none;
    }

    .intro-inner {
      max-width: 1100px;
      width: 92vw;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }

    #intro-video {
      width: 100%;
      max-height: 70vh;
      border-radius: 18px;
      border: 3px solid rgba(250,204,21,0.85);
      box-shadow:
        0 0 0 1px rgba(15,23,42,0.9),
        0 20px 40px rgba(0,0,0,0.8);
      background: #000;
    }

    .intro-controls {
      display: flex;
      gap: 10px;
      margin-top: 8px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .intro-controls button {
      border-radius: 999px;
      border: 1px solid rgba(250,204,21,0.7);
      background:
        radial-gradient(circle at top, #fef9c3 0%, #facc6b 45%, #d97706 100%);
      padding: 6px 18px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
      color: #111827;
      box-shadow: 0 4px 12px rgba(0,0,0,0.6);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-family: "Cinzel", "Georgia", serif;
    }

    .intro-controls button#intro-skip {
      background: #111827;
      color: #e5e7eb;
      border-color: #4b5563;
    }

    .intro-controls button:hover {
      filter: brightness(1.06);
      box-shadow: 0 6px 16px rgba(0,0,0,0.8);
    }

    /* ===================== GAME CONTAINER ===================== */

    #game-container {
      position: relative;
      z-index: 1;
      width: 100%;
      transition: opacity 0.8s ease, transform 0.8s ease;
    }

    .game-hidden {
      opacity: 0;
      pointer-events: none;
      transform: translateY(10px);
    }

    .game-visible {
      opacity: 1;
      pointer-events: auto;
      transform: translateY(0);
    }

    header {
      text-align: center;
      padding: 20px 8px 12px;
      text-shadow: 0 0 12px rgba(0,0,0,0.8);
      position: relative;
      z-index: 1;
    }

    header h1 {
      margin: 0;
      font-size: 2.3rem;
      color: var(--bb-cream);
      font-family: "Cinzel", "Georgia", serif;
      letter-spacing: 0.08em;
    }

    header p {
      margin: 4px 0 0;
      font-size: 0.9rem;
      opacity: 0.9;
    }

    .layout {
      display: flex;
      flex-direction: column;
      gap: 10px;
      flex: 1;
      padding: 10px;
      position: relative;
      z-index: 1;
    }

    .top-bar {
      display: flex;
      justify-content: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .top-bar button {
      border-radius: 999px;
      border: 1px solid rgba(250,204,21,0.7);
      background:
        radial-gradient(circle at top, #fef9c3 0%, #facc6b 45%, #d97706 100%);
      padding: 4px 16px;
      cursor: pointer;
      font-size: 0.8rem;
      font-weight: 600;
      color: #1f2937;
      box-shadow: 0 3px 10px rgba(0,0,0,0.45);
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .top-bar button:hover {
      filter: brightness(1.06);
      box-shadow: 0 4px 14px rgba(0,0,0,0.6);
    }

    .scoreboard {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 12px;
    }

    /* ✨ House cards with soft glow + faux “glass” */
    .team {
      position: relative;
      background:
        radial-gradient(circle at top, rgba(248,250,252,0.15), rgba(15,23,42,0.96));
      border-radius: 18px;
      padding: 10px 14px 12px;
      min-width: 170px;
      display: flex;
      flex-direction: column;
      align-items: center;
      border: 1px solid rgba(148,163,184,0.7);
      box-shadow:
        0 0 0 1px rgba(15,23,42,0.9),
        0 10px 22px rgba(0,0,0,0.7);
      overflow: hidden;
    }

    .team::before {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: inherit;
      background: linear-gradient(135deg,
        rgba(250,250,250,0.35),
        transparent 40%,
        rgba(250,204,21,0.3),
        transparent 70%);
      opacity: 0.35;
      mix-blend-mode: screen;
      pointer-events: none;
    }

    .team-crest {
      width: 58px;
      height: 58px;
      object-fit: contain;
      margin-bottom: 4px;
      filter: drop-shadow(0 0 7px rgba(0,0,0,0.85));
      animation: floatCrest 5.5s ease-in-out infinite;
    }

    @keyframes floatCrest {
      0%   { transform: translateY(0); }
      50%  { transform: translateY(-3px); }
      100% { transform: translateY(0); }
    }

    .team input {
      background: transparent;
      border: none;
      border-bottom: 1px solid rgba(148,163,184,0.9);
      color: #f9fafb;
      text-align: center;
      margin-bottom: 4px;
      font-weight: 600;
      width: 100%;
      font-family: "Cinzel", "Georgia", serif;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      font-size: 0.78rem;
    }

    .team input:focus {
      outline: none;
      border-bottom-color: var(--bb-gold);
    }

    .score {
      font-size: 1.4rem;
      color: var(--bb-gold);
      margin-bottom: 6px;
      font-weight: bold;
      text-shadow: 0 0 10px rgba(0,0,0,0.9);
    }

    .score-controls {
      display: flex;
      gap: 4px;
    }

    .score-controls button {
      border-radius: 999px;
      padding: 3px 8px;
      border: none;
      cursor: pointer;
      font-size: 0.78rem;
      font-weight: 600;
      font-family: inherit;
      box-shadow: 0 2px 6px rgba(0,0,0,0.45);
    }

    .add { background: #16a34a; color: #f9fafb; }
    .sub { background: #b91c1c; color: #f9fafb; }

    .score-controls button:hover {
      filter: brightness(1.08);
    }

    .board-wrapper {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: stretch;
      padding: 6px 0 10px;
      overflow-x: auto;
    }

    #board {
      display: grid;
      gap: 4px;
      max-width: 1200px;
      width: 100%;
    }

    /* ✨ Shimmering parchment category headers */
    .category-header {
      position: relative;
      background: radial-gradient(circle at top,
        #fff7e3 0%,
        #f5e2be 55%,
        #e5c792 100%);
      border-radius: 26px;
      border: 3px solid var(--bb-gold);
      color: var(--bb-text-dark);
      padding: 10px 6px;
      font-weight: 700;
      text-align: center;
      box-shadow:
        0 0 0 1px rgba(255,255,255,0.9) inset,
        0 6px 12px rgba(0,0,0,0.6);
      word-wrap: break-word;
      font-family: "Cinzel", "Georgia", serif;
      letter-spacing: 0.03em;
    }

    .category-header::after {
      content: "";
      position: absolute;
      top: 0;
      left: -40%;
      width: 40%;
      height: 100%;
      background: linear-gradient(120deg,
        transparent,
        rgba(255,255,255,0.55),
        transparent);
      opacity: 0;
      transform: skewX(-20deg);
      animation: headerShine 10s ease-in-out infinite;
    }

    @keyframes headerShine {
      0%, 70%  { opacity: 0; transform: translateX(-120%) skewX(-20deg); }
      75%      { opacity: 1; transform: translateX(120%)  skewX(-20deg); }
      100%     { opacity: 0; transform: translateX(160%)  skewX(-20deg); }
    }

    /* ✨ Glowing tiles */
    .tile {
      background: radial-gradient(circle at top,
        var(--bb-soft-blue),
        var(--bb-soft-blue-dark));
      border-radius: 10px;
      border: 2px solid var(--bb-gold);
      padding: 10px 6px;
      font-size: 1.4rem;
      font-weight: 700;
      color: var(--bb-gold-deep);
      text-align: center;
      cursor: pointer;
      min-height: 72px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.7);
      transition:
        transform 0.08s ease,
        box-shadow 0.08s ease,
        filter 0.08s ease;
      text-shadow: 0 0 4px rgba(255,255,255,0.6);
      animation: tileGlow 4.5s ease-in-out infinite;
    }

    .tile:hover {
      transform: translateY(-2px) scale(1.01);
      box-shadow: 0 8px 18px rgba(0,0,0,0.85);
      filter: brightness(1.05);
    }

    @keyframes tileGlow {
      0%   { box-shadow: 0 4px 10px rgba(0,0,0,0.6); }
      50%  { box-shadow: 0 0 18px rgba(191,219,254,0.8); }
      100% { box-shadow: 0 4px 10px rgba(0,0,0,0.6); }
    }

    .tile.used {
      background: #cbd5f5;
      color: #4b5563;
      cursor: default;
      text-shadow: none;
      box-shadow: none;
      transform: none;
      filter: none;
      animation: none;
    }

    .status {
      text-align: center;
      font-size: 0.85rem;
      opacity: 0.9;
      min-height: 1.2em;
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(5,10,25,0.85);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 40;
    }

    .modal-backdrop.active {
      display: flex;
    }

    .modal {
      background: radial-gradient(circle, #ffffff, #f5e6cd);
      border-radius: 18px;
      border: 4px solid var(--bb-gold);
      padding: 14px 16px 16px;
      max-width: 800px;
      width: 96%;
      color: var(--bb-text-dark);
      box-shadow: 0 16px 40px rgba(0,0,0,0.9);
      position: relative;
    }

    .modal::before {
      content: "";
      position: absolute;
      inset: 4px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.85);
      pointer-events: none;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 8px;
    }

    .modal-header h2 {
      margin: 0;
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--bb-text-soft);
      font-family: "Cinzel", "Georgia", serif;
    }

    .modal-header span {
      font-weight: 600;
      color: var(--bb-gold-deep);
    }

    .modal-question {
      font-size: 1.02rem;
      line-height: 1.4;
      margin-top: 4px;
    }

    .modal-image {
      margin-top: 10px;
      text-align: center;
    }

    .modal-image img {
      max-width: 100%;
      max-height: 260px;
      border-radius: 12px;
      border: 2px solid rgba(148,163,184,0.8);
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
    }

    .modal-answer {
      margin-top: 10px;
      padding: 8px 10px;
      border-radius: 12px;
      background: rgba(255,255,255,0.96);
      border: 1px dashed rgba(148,163,184,0.9);
      display: none;
      font-size: 0.96rem;
    }

    .modal-footer {
      margin-top: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .team-award-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      justify-content: center;
    }

    .team-award-row button {
      border-radius: 999px;
      border: 1px solid var(--bb-gold-deep);
      background: radial-gradient(circle at top, #fef9c3 0%, #facc6b 45%, #d97706 100%);
      color: #1f2937;
      padding: 5px 12px;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 600;
      min-width: 130px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.5);
    }

    .team-award-row button:hover {
      filter: brightness(1.06);
    }

    .modal-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: space-between;
    }

    .modal-controls button {
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: #111827;
      color: #e5e7eb;
      padding: 5px 12px;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 500;
      font-family: inherit;
      box-shadow: 0 3px 8px rgba(0,0,0,0.6);
    }

    .modal-controls button.primary {
      background: var(--bb-deep-blue);
      border-color: #020617;
    }

    .modal-controls button.danger {
      background: #b91c1c;
      border-color: #7f1d1d;
    }

    .modal-controls button:hover {
      filter: brightness(1.08);
    }

    /* ===================== TIMER STYLES ===================== */
    .timer-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(15,23,42,0.06);
      border: 1px solid rgba(148,163,184,0.7);
      font-size: 0.9rem;
    }

    .timer-row span {
      font-weight: 600;
      color: var(--bb-text-soft);
    }

    #timer-display {
      min-width: 46px;
      text-align: center;
      font-size: 1.1rem;
      font-weight: 700;
      padding: 3px 10px;
      border-radius: 999px;
      background: #e5f0ff;
      border: 1px solid #60a5fa;
      color: #1e3a8a;
      box-shadow: 0 0 8px rgba(191,219,254,0.8);
    }

    #timer-display.timer-low {
      background: #fef3c7;
      border-color: #facc15;
      color: #92400e;
      box-shadow: 0 0 10px rgba(250,204,21,0.8);
    }

    #timer-display.timer-finished {
      background: #fee2e2;
      border-color: #b91c1c;
      color: #7f1d1d;
      animation: timerFlash 0.6s ease-in-out infinite alternate;
      box-shadow: 0 0 12px rgba(248,113,113,0.9);
    }

    @keyframes timerFlash {
      0%   { transform: scale(1);     opacity: 0.8; }
      100% { transform: scale(1.05);  opacity: 1;   }
    }

    .timer-row button {
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: #111827;
      color: #e5e7eb;
      padding: 4px 10px;
      cursor: pointer;
      font-size: 0.8rem;
      font-weight: 500;
      box-shadow: 0 2px 6px rgba(0,0,0,0.5);
    }

    .timer-row button.primary {
      background: var(--bb-deep-blue);
      border-color: #020617;
    }

    .timer-row button:hover {
      filter: brightness(1.08);
    }

    @media (max-width: 768px) {
      header h1 { font-size: 1.7rem; }
      .tile { font-size: 1.15rem; min-height: 60px; }
      .category-header { font-size: 0.9rem; }
    }
  </style>
</head>
<body>

  <!-- ===================== INTRO SCREEN ===================== -->
  <div id="intro-screen">
    <div class="intro-inner">
      <video id="intro-video" preload="auto">
        <source src="Images/Wizardsjeopardy_IntroVIdeo.mp4" type="video/mp4">
        Your browser does not support the video tag.
      </video>
      <div class="intro-controls">
        <button id="intro-play">Play Intro</button>
        <button id="intro-skip">Skip to Game</button>
      </div>
    </div>
  </div>

  <!-- ===================== GAME CONTAINER ===================== -->
  <div id="game-container" class="game-hidden">
    <header>
      <h1>Beauxbatons Challenge - Wizards Jeopardy</h1>
      <p>Questions and categories are loaded live from Google Sheets</p>
    </header>

    <div class="layout">
      <div class="top-bar">
        <button id="reload-data">Reload questions</button>
        <button id="reset-board">Reset board</button>
        <button id="reset-scores">Reset scores</button>
      </div>

      <div class="scoreboard">
        <div class="team" data-team="0">
          <img src="Images/Beauxbaton.png" alt="Beauxbatons crest" class="team-crest">
          <input type="text" value="Beauxbatons" />
          <div class="score" id="score-0">0</div>
          <div class="score-controls">
            <button class="sub" data-team="0">-100</button>
            <button class="add" data-team="0">+100</button>
          </div>
        </div>

        <div class="team" data-team="1">
          <img src="Images/Hogwarts.png" alt="Hogwarts crest" class="team-crest">
          <input type="text" value="Hogwarts" />
          <div class="score" id="score-1">0</div>
          <div class="score-controls">
            <button class="sub" data-team="1">-100</button>
            <button class="add" data-team="1">+100</button>
          </div>
        </div>

        <div class="team" data-team="2">
          <img src="Images/Durmstrang.png" alt="Durmstrang crest" class="team-crest">
          <input type="text" value="Durmstrang" />
          <div class="score" id="score-2">0</div>
          <div class="score-controls">
            <button class="sub" data-team="2">-100</button>
            <button class="add" data-team="2">+100</button>
          </div>
        </div>

        <div class="team" data-team="3">
          <img src="Images/Ilvermorny.png" alt="Ilvermorny crest" class="team-crest">
          <input type="text" value="Ilvermorny" />
          <div class="score" id="score-3">0</div>
          <div class="score-controls">
            <button class="sub" data-team="3">-100</button>
            <button class="add" data-team="3">+100</button>
          </div>
        </div>
      </div>

      <div class="board-wrapper">
        <div id="board"></div>
      </div>

      <div class="status" id="status"></div>
    </div>
  </div>

  <!-- Question modal -->
  <div class="modal-backdrop" id="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <h2 id="modal-category">Category</h2>
        <span id="modal-value">0</span>
      </div>
      <div class="modal-question" id="modal-question"></div>

      <div class="modal-image" id="modal-image" style="display:none;">
        <img id="modal-image-tag" src="" alt="Question image" />
      </div>

      <div class="modal-answer" id="modal-answer">
        <strong>Answer: </strong><span id="modal-answer-text"></span>
      </div>

      <div class="modal-footer">
        <!-- Timer row -->
        <div class="timer-row">
          <span>Time left:</span>
          <span id="timer-display">60</span>
          <button id="timer-start" class="primary">Start 60s</button>
          <button id="timer-reset">Reset</button>
        </div>

        <div class="team-award-row" id="award-buttons"></div>

        <div class="modal-controls">
          <button id="show-answer" class="primary">Show answer</button>
          <button id="no-points">No points</button>
          <button id="close-modal" class="danger">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const CSV_URL =
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vTp9jiAXHLSXP4d983ipXv0fKZheaaJLSt4OYWgLookJisCeWVuMwZhXKi7VFpkx-SsSVhNyyL95xO3/pub?gid=0&single=true&output=csv";

    let questionsByCategory = [];
    let valuesSorted = [];
    const scores = [0, 0, 0, 0];

    const board = document.getElementById("board");
    const statusEl = document.getElementById("status");

    const backdrop = document.getElementById("modal-backdrop");
    const modalCategory = document.getElementById("modal-category");
    const modalValue = document.getElementById("modal-value");
    const modalQuestion = document.getElementById("modal-question");
    const modalAnswer = document.getElementById("modal-answer");
    const modalAnswerText = document.getElementById("modal-answer-text");
    const modalImageWrapper = document.getElementById("modal-image");
    const modalImageTag = document.getElementById("modal-image-tag");
    const awardButtons = document.getElementById("award-buttons");

    const showAnswerBtn = document.getElementById("show-answer");
    const noPointsBtn = document.getElementById("no-points");
    const closeModalBtn = document.getElementById("close-modal");
    const reloadDataBtn = document.getElementById("reload-data");
    const resetBoardBtn = document.getElementById("reset-board");
    const resetScoresBtn = document.getElementById("reset-scores");

    const timerDisplay = document.getElementById("timer-display");
    const timerStartBtn = document.getElementById("timer-start");
    const timerResetBtn = document.getElementById("timer-reset");

    let currentTile = null;
    let currentQuestion = null;

    let timerInterval = null;
    let timerRemaining = 60;

    function setStatus(msg) {
      statusEl.textContent = msg || "";
    }

    function updateTimerDisplay() {
      if (!timerDisplay) return;
      timerDisplay.textContent = timerRemaining;

      timerDisplay.classList.remove("timer-low", "timer-finished");

      if (timerRemaining <= 0) {
        timerDisplay.textContent = "0";
        timerDisplay.classList.add("timer-finished");
      } else if (timerRemaining <= 10) {
        timerDisplay.classList.add("timer-low");
      }
    }

    function resetTimer() {
      clearInterval(timerInterval);
      timerInterval = null;
      timerRemaining = 60;
      updateTimerDisplay();
    }

    function startTimer() {
      clearInterval(timerInterval);
      timerInterval = setInterval(() => {
        timerRemaining -= 1;
        if (timerRemaining <= 0) {
          timerRemaining = 0;
          clearInterval(timerInterval);
          timerInterval = null;
        }
        updateTimerDisplay();
      }, 1000);
      updateTimerDisplay();
    }

    function fetchQuestions() {
      setStatus("Loading questions from Google Sheets...");
      return new Promise((resolve, reject) => {
        Papa.parse(CSV_URL, {
          download: true,
          header: true,
          complete: result => {
            const rows = result.data.filter(r => r.Category && r.Value);
            resolve(rows);
          },
          error: err => reject(err)
        });
      });
    }

    function processRows(rows) {
      const categoryMap = new Map();
      const valueSet = new Set();

      rows.forEach(row => {
        const cat = row.Category.trim();
        const value = parseInt(row.Value, 10) || 0;
        const question = (row.Question || "").trim();
        const answer = (row.Answer || "").trim();
        const image = (row["Image (Optional)"] || row.Image || "").trim();

        if (!cat || !value || !question) return;

        if (!categoryMap.has(cat)) {
          categoryMap.set(cat, []);
        }
        categoryMap.get(cat).push({ value, question, answer, image });
        valueSet.add(value);
      });

      questionsByCategory = Array.from(categoryMap.entries()).map(([category, qs]) => {
        qs.sort((a, b) => a.value - b.value);
        return { category, questions: qs };
      });

      valuesSorted = Array.from(valueSet).sort((a, b) => a - b);
    }

    function buildBoard() {
      board.innerHTML = "";

      if (!questionsByCategory.length) {
        setStatus("No questions found. Check the sheet.");
        return;
      }

      board.style.gridTemplateColumns = `repeat(${questionsByCategory.length}, 1fr)`;

      questionsByCategory.forEach(col => {
        const header = document.createElement("div");
        header.className = "category-header";
        header.textContent = col.category;
        board.appendChild(header);
      });

      valuesSorted.forEach(value => {
        questionsByCategory.forEach((col, colIndex) => {
          const tile = document.createElement("div");
          tile.className = "tile";

          const q = col.questions.find(q => q.value === value);

          if (q) {
            tile.textContent = value;
            tile.dataset.col = colIndex;
            tile.dataset.value = value;
            tile.addEventListener("click", onTileClick);
          } else {
            tile.classList.add("used");
            tile.textContent = "";
          }

          board.appendChild(tile);
        });
      });

      setStatus("Board ready.");
    }

    function updateScores() {
      scores.forEach((val, i) => {
        const el = document.getElementById(`score-${i}`);
        if (el) el.textContent = val;
      });
    }

    function changeScore(teamIndex, delta) {
      scores[teamIndex] += delta;
      updateScores();
    }

    document.querySelectorAll(".score-controls button").forEach(button => {
      button.addEventListener("click", () => {
        const teamIndex = parseInt(button.dataset.team, 10);
        if (button.classList.contains("add")) {
          changeScore(teamIndex, 100);
        } else {
          changeScore(teamIndex, -100);
        }
      });
    });

    function onTileClick(e) {
      const tile = e.currentTarget;
      if (tile.classList.contains("used")) return;

      const colIndex = parseInt(tile.dataset.col, 10);
      const value = parseInt(tile.dataset.value, 10);

      const col = questionsByCategory[colIndex];
      if (!col) return;
      const q = col.questions.find(q => q.value === value);
      if (!q) return;

      currentTile = tile;
      currentQuestion = q;

      modalCategory.textContent = col.category;
      modalValue.textContent = value;
      modalQuestion.textContent = q.question;
      modalAnswerText.textContent = q.answer || "(No answer set)";
      modalAnswer.style.display = "none";

      if (q.image) {
        modalImageWrapper.style.display = "block";
        modalImageTag.src = q.image;
      } else {
        modalImageWrapper.style.display = "none";
        modalImageTag.src = "";
      }

      buildAwardButtons(value);

      // Reset and auto-start timer on new question
      resetTimer();
      startTimer();

      backdrop.classList.add("active");
    }

    function buildAwardButtons(value) {
      awardButtons.innerHTML = "";
      const teamCards = document.querySelectorAll(".team");

      teamCards.forEach((card, index) => {
        const nameInput = card.querySelector("input");
        const teamName = nameInput.value || `Team ${index + 1}`;

        const button = document.createElement("button");
        button.textContent = `${teamName} correct (+${value})`;
        button.addEventListener("click", () => {
          changeScore(index, value);
          markTileUsed();
          closeModal();
        });
        awardButtons.appendChild(button);
      });
    }

    function markTileUsed() {
      if (currentTile) {
        currentTile.classList.add("used");
        currentTile.textContent = "";
      }
    }

    function closeModal() {
      backdrop.classList.remove("active");
      resetTimer();
    }

    showAnswerBtn.addEventListener("click", () => {
      if (modalAnswer.style.display === "none") {
        modalAnswer.style.display = "block";
      } else {
        modalAnswer.style.display = "none";
      }
    });

    noPointsBtn.addEventListener("click", () => {
      markTileUsed();
      closeModal();
    });

    closeModalBtn.addEventListener("click", () => {
      closeModal();
    });

    reloadDataBtn.addEventListener("click", () => {
      loadEverything(true);
    });

    resetBoardBtn.addEventListener("click", () => {
      if (confirm("Reset all tiles (scores stay)?")) {
        buildBoard();
      }
    });

    resetScoresBtn.addEventListener("click", () => {
      if (confirm("Reset all scores to zero?")) {
        for (let i = 0; i < scores.length; i++) scores[i] = 0;
        updateScores();
      }
    });

    timerStartBtn.addEventListener("click", () => {
      if (timerRemaining === 0) {
        timerRemaining = 60;
      }
      startTimer();
    });

    timerResetBtn.addEventListener("click", () => {
      resetTimer();
    });

    async function loadEverything(fromButton) {
      try {
        if (fromButton) setStatus("Reloading questions...");
        const rows = await fetchQuestions();
        processRows(rows);
        buildBoard();
      } catch (e) {
        console.error(e);
        setStatus("Error loading questions. Check console.");
      }
    }

    // ===================== INTRO LOGIC =====================

    const introScreen = document.getElementById("intro-screen");
    const introVideo = document.getElementById("intro-video");
    const introPlay = document.getElementById("intro-play");
    const introSkip = document.getElementById("intro-skip");
    const gameContainer = document.getElementById("game-container");

    function showGame() {
      introScreen.classList.add("hide-intro");
      gameContainer.classList.remove("game-hidden");
      gameContainer.classList.add("game-visible");
      introVideo.pause();
    }

    introPlay.addEventListener("click", () => {
      introVideo.currentTime = 0;
      introVideo.play();
    });

    introSkip.addEventListener("click", () => {
      showGame();
    });

    introVideo.addEventListener("ended", () => {
      showGame();
    });

    // ===================== INIT =====================

    loadEverything(false);
    updateScores();
    updateTimerDisplay();
  </script>
</body>
</html>
